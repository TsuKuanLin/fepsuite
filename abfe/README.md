###FEP-ABFE: free-energy perturbation with absolute binding free energy calculation

# Prepration

Before running the script, prepare mdtraj and pyedr package for python3.
```sh
% pip3 install mdtraj pyedr --user
% python3 -c "import mdtraj"
```
You may also need to make sure these modules can be accessed through your job submission system (a.k.a. qsub).

Also, you need `zsh` to be installed. You can check by, for example:
```sh
% zsh -c "echo ZSH works"
```

# Calculating the free energy
Then, follow the next order to run the FEP-ABFE.

1. Prepare topology with protein + ligand + water + ions of you want to calculate. If you are starting from the structure generated by docking, please see the latter section before proceeding the calculation. We recommend to use rhombic dodecahedron box for the solvation. The system must be neutralized.
2. Set topology file name as `topol_ionized.top` and coorinate file as `conf_ionized.pdb` or `conf_ionized.gro`. (You can use symlink for that).
3. Prepare a directory with two depths, e.g. `abfecalc/mol1`. Put topology and structure files under `abfecalc/mol1`.
4. Clone this git repository to somewhere, e.g. `$HOME/repos/fep-abfe`.
5. Copy `para_conf.zsh`, and an appropriate submission script under `example_submit_script` to `abfecalc/`. Copy whole `mdp_template` directory to `abfecalc/`, and rename the directory name to `mdp`. If necessary, modify mdp files according to your calculation conditions.
6. Modify submission script's `ABFE_ROOT` to git repository root such as `$HOME/repos/fep-abfe`.
7. Modify `para_conf.zsh` according to your calculation environment.
8. Chdir to `abfecalc` directory, e.g. `cd $HOME/abfecalc`. 
9. Run the submission script with secondary directory name (in this case `mol1`) and `all`, e.g. `./titech_tsubame3.zsh mol1 all`. The script will submit all necessary jobs.
10. Wait until all calculations finish.
11. If everything works fine, output should be generated at `abfecalc/mol1/result.txt`.

# How to interpret the result
```
annihilation-complex -5.449 0.837
annihilation-lig -4.264 0.253
charging-complex -26.856 0.268
charging-lig 23.439 0.079
lr-annihilation-complex 6.986 0.054
lr-annihilation-lig 0.095 0.002
lr-complex -7.244 0.062
lr-lig -0.248 0.002
restrain -0.872 0.010
restrain-analytical 2.246 0.000
----
annihilation -9.713 0.874
charging -3.418 0.279
long-range-correction -0.411 0.083
restrain 1.374 0.010
----
total -12.168 0.921
```
Each line comprises of name, mean value and standard deviation of each value in kcal/mol.
First section represents contributions from individual terms of the thermodynamic cycle. These signs of these values are set so that the total value, in the last section, is just the summation of these values.
Second section represents subtotals of the first section, separated by major contributin factors. 
The total value represents the final free-energy difference. In the above example, it's -12.168 kcal/mol +/- 0.921 kcal/mol. 

# Starting from docking results
Typically, poses obtained from docking simulation are not stable. We recommend the following way to sample configurations. (TODO)

# Caveats (TODO)
In some supercomputers (like Univ. Tokyo) you may not be able to access `$HOME` from computation nodes. For these exotic systems, you need to install python packages into non-default directories, and you need to set `PYTHONPATH` correctly. 
